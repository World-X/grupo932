---
import SchedulePost from '@components/SchedulePost.astro'
import MainGridLayout from '../layouts/MainGridLayout.astro'
/*
import {
  getIconData,
  iconToSVG,
} from '../../node_modules/.pnpm/astro-icon@1.1.1/node_modules/@iconify/utils'
*/
/* REMINDER: To install icon packages from Iconify, use pnpm i -D @iconify-json/{package_name} */
---
<MainGridLayout title="Horario" description="Horario">
    <div class="text-90 flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full ">
            <SchedulePost></SchedulePost>
        </div>
    </div>
</MainGridLayout>
<script is:inline>
console.log("Hello from schedule.astro");
applySubGroup(localStorage.getItem("subgroup"));
setupHours(window.matchMedia("(max-width: 768px)").matches);
// hideSubjectData();

// Call setupHours function when screen is resized
window.addEventListener("resize", function () {
    console.log("Resized");
    setupHours(window.matchMedia("(max-width: 768px)").matches);
});

// Muestra el dia de la semana (Lunes, Martes, etc.)
// document.getElementById("date-element").textContent = new Date().toLocaleDateString("es-ES", { weekday: "long" });

function setupHours(is_screen_medium) {
    // Get all elements with "hour" class, IF screen is medium, set their content to an hour (from 13:00 to 19:00), ELSE set their content to an hour (from 13:00 to 19:00) and a dash followed by the next hour
    let hours = document.getElementsByClassName("hour");
    if (hours) {
        for (let i = 0; i < hours.length; i++) {
            let hour = hours[i];
            if (is_screen_medium) {
                hour.textContent = `${13 + i}:00`;
            } else {
                hour.textContent = `${13 + i}:00 - ${14 + i}:00`;
            }
        }
    }
}

function scheduleSwitchButton() {
    let panel = document.getElementById("schedule-settings-panel");
    let scheduleSettingsIcon = document.getElementById("schedule-settings-icon");
    const settingsSVG = "M10.825 22q-.675 0-1.162-.45t-.588-1.1L8.85 18.8q-.325-.125-.612-.3t-.563-.375l-1.55.65q-.625.275-1.25.05t-.975-.8l-1.175-2.05q-.35-.575-.2-1.225t.675-1.075l1.325-1Q4.5 12.5 4.5 12.337v-.675q0-.162.025-.337l-1.325-1Q2.675 9.9 2.525 9.25t.2-1.225L3.9 5.975q.35-.575.975-.8t1.25.05l1.55.65q.275-.2.575-.375t.6-.3l.225-1.65q.1-.65.588-1.1T10.825 2h2.35q.675 0 1.163.45t.587 1.1l.225 1.65q.325.125.613.3t.562.375l1.55-.65q.625-.275 1.25-.05t.975.8l1.175 2.05q.35.575.2 1.225t-.675 1.075l-1.325 1q.025.175.025.338v.674q0 .163-.05.338l1.325 1q.525.425.675 1.075t-.2 1.225l-1.2 2.05q-.35.575-.975.8t-1.25-.05l-1.5-.65q-.275.2-.575.375t-.6.3l-.225 1.65q-.1.65-.587 1.1t-1.163.45zm1.225-6.5q1.45 0 2.475-1.025T15.55 12t-1.025-2.475T12.05 8.5q-1.475 0-2.488 1.025T8.55 12t1.013 2.475T12.05 15.5";
    const closeSVG = "m12 13.4l-4.9 4.9q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7l4.9-4.9l-4.9-4.9q-.275-.275-.275-.7t.275-.7t.7-.275t.7.275l4.9 4.9l4.9-4.9q.275-.275.7-.275t.7.275t.275.7t-.275.7L13.4 12l4.9 4.9q.275.275.275.7t-.275.7t-.7.275t-.7-.275z";
    if (panel) {
        if (panel.style.display === "none") {
            panel.style.display = "block";
            scheduleSettingsIcon.getElementsByTagName("path")[0].setAttribute("d", closeSVG);
        } else {
            panel.style.display = "none";
            scheduleSettingsIcon.getElementsByTagName("path")[0].setAttribute("d", settingsSVG);
        }
    }
}

function setSubGroup(subgroup) {
    localStorage.setItem("subgroup", subgroup);
    applySubGroup(subgroup);
}

function applySubGroup(subgroup) {
    console.log("Applying subgroup: ", subgroup);
    // Buttons for subgroup selection
    let buttonOne = document.getElementById("subgroup-one-button");
    let buttonTwo = document.getElementById("subgroup-two-button");
    // Buttons for subject selection
    let subPeOdlc = document.getElementById("sub-pe-odlc");
    let subEaLc = document.getElementById("sub-ea-lc");
    let subLcEa = document.getElementById("sub-lc-ea");
    let subOdlcPe = document.getElementById("sub-odlc-pe");
    // Get current day and hour (to prevent errors, we will have to check first if the elements exist)
    let currentDayElement = document.getElementById("current-day-selected-var");
    let currentHourElement = document.getElementById("current-hour-selected-var");
    let currentDay = -1;
    let currentHour = -1;
    if (currentDayElement) {
        currentDay = parseInt(currentDayElement.textContent);
    }
    if (currentHourElement) {
        currentHour = parseInt(currentHourElement.textContent);
    }
    if (buttonOne) {
        if (buttonTwo) {
            if (subgroup == '1') {
                console.log("Subgroup 1");
                // Change button styles
                buttonOne.classList.add("current-theme-btn");
                buttonTwo.classList.remove("current-theme-btn");
                // Change subject buttons
                subPeOdlc.classList.remove("odlc");
                subPeOdlc.classList.add("pe");
                subEaLc.classList.remove("lc");
                subEaLc.classList.add("ea");
                subLcEa.classList.remove("ea");
                subLcEa.classList.add("lc");
                subOdlcPe.classList.remove("pe");
                subOdlcPe.classList.add("odlc");
                // Change button text
                subPeOdlc.getElementsByTagName("button")[0].textContent = "Programación Estructurada";
                subEaLc.getElementsByTagName("button")[0].textContent = "Estadística Avanzada";
                subLcEa.getElementsByTagName("button")[0].textContent = "Lenguaje C";
                subOdlcPe.getElementsByTagName("button")[0].textContent = "Organización de las Computadoras";
            } else if (subgroup == '2') {
                console.log("Subgroup 2");
                // Change button styles
                buttonOne.classList.remove("current-theme-btn");
                buttonTwo.classList.add("current-theme-btn");
                // Change subject buttons
                subPeOdlc.classList.remove("pe");
                subPeOdlc.classList.add("odlc");
                subEaLc.classList.remove("ea");
                subEaLc.classList.add("lc");
                subLcEa.classList.remove("lc");
                subLcEa.classList.add("ea");
                subOdlcPe.classList.remove("odlc");
                subOdlcPe.classList.add("pe");
                // Change button text
                subPeOdlc.getElementsByTagName("button")[0].textContent = "Organización de las Computadoras";
                subEaLc.getElementsByTagName("button")[0].textContent = "Lenguaje C";
                subLcEa.getElementsByTagName("button")[0].textContent = "Estadística Avanzada";
                subOdlcPe.getElementsByTagName("button")[0].textContent = "Programación Estructurada";
            } else {
                console.error("Invalid subgroup: ", subgroup);
            }
        }
    }
    if (currentDay != -1 && currentHour != -1) {
        showSubjectData(currentDay, currentHour, false);
    }
}

// NOTE: Will refactor this code, so functions regarding subjectData take a day and hour parameters instead of a subject id number

function getSubjectData(day = 0, hour = 13) {
    const DEFAULT_SUBJECT_DATA = {
        name: "Name",
        hour: "Hour",
        teacher: "Teacher",
        classroom: "Classroom",
        subgroup: "Subgroup",
        type: "Type"
    };
    switch (day) {
        case 0: // Monday
            switch (hour) {
                case 13: // 13:00 or 1:00PM
                    return {
                        tag: "lc",
                        name: "Lenguaje C",
                        hour: "13:00 - 14:00",
                        teacher: "Antillón Macías César",
                        classroom: "E45 - 301",
                        subgroup: "Ambos",
                        type: "Clase"
                    };
                case 14: case 15: // 14:00 or 2:00PM
                    return {
                        tag: "tys",
                        name: "Tecnología y Sociedad",
                        hour: "14:00 - 16:00",
                        teacher: "Rangel Lopez Claudia Margarita",
                        classroom: "E45 - 301",
                        subgroup: "Ambos",
                        type: "Taller"
                    };
                case 16: case 17: // 16:00 or 4:00PM
                    return {
                        tag: "pe",
                        name: "Programación Estructurada",
                        hour: "16:00 - 18:00",
                        teacher: "Nuñez Yepiz Pedro",
                        classroom: "E45 - 301",
                        subgroup: "Ambos",
                        type: "Taller"
                    }
                default:
                    return DEFAULT_SUBJECT_DATA;
            }
        case 1: // Tuesday
            switch (hour) {
                case 13: case 14: // 13:00 or 1:00PM
                    return {
                        tag: "ea",
                        name: "Estadística Avanzada",
                        hour: "13:00 - 15:00",
                        teacher: "Nieto Hipólito Juan Iván",
                        classroom: "E45 - 301",
                        subgroup: "Ambos",
                        type: "Clase"
                    };
                case 15: // 15:00 or 3:00PM
                    return {
                        tag: "mdli",
                        name: "Metodología de la Investigación",
                        hour: "15:00 - 16:00",
                        teacher: "López Sánchez Carlos Saul",
                        classroom: "E45 - 301",
                        subgroup: "Ambos",
                        type: "Clase"
                    };
                case 16: case 17: // 16:00 or 4:00PM
                    if (localStorage.getItem("subgroup") == '1') {
                        return {
                            tag: "pe",
                            name: "Programación Estructurada",
                            hour: "16:00 - 18:00",
                            teacher: "Nuñez Yepiz Pedro",
                            classroom: "E40 - A",
                            subgroup: "1",
                            type: "Laboratorio"
                        }
                    } else {
                        return {
                            tag: "odlc",
                            name: "Organización de las Computadoras",
                            hour: "16:00 - 18:00",
                            teacher: "Crespo Ragland Jonatan",
                            classroom: "E40 - B",
                            subgroup: "2",
                            type: "Laboratorio"
                        };
                    }
                default:
                    return DEFAULT_SUBJECT_DATA;
            }
        case 2: // Wednesday
            switch (hour) {
                case 13: case 14: // 13:00 or 1:00PM
                    if (localStorage.getItem("subgroup") == '1') {
                        return {
                            tag: "ea",
                            name: "Estadística Avanzada",
                            hour: "13:00 - 15:00",
                            teacher: "Nieto Hipólito Juan Iván",
                            classroom: "E40 - C",
                            subgroup: "1",
                            type: "Laboratorio"
                        };
                    } else {
                        return {
                            tag: "lc",
                            name: "Lenguaje C",
                            hour: "13:00 - 15:00",
                            teacher: "Antillón Macías César",
                            classroom: "E40 - B",
                            subgroup: "2",
                            type: "Laboratorio"
                        };
                    }
                case 15: case 16: // 15:00 or 3:00PM
                    if (localStorage.getItem("subgroup") == '1') {
                        return {
                            tag: "lc",
                            name: "Lenguaje C",
                            hour: "15:00 - 17:00",
                            teacher: "Antillón Macías César",
                            classroom: "E40 - C",
                            subgroup: "1",
                            type: "Laboratorio"
                        };
                    } else {
                        return {
                            tag: "ea",
                            name: "Estadística Avanzada",
                            hour: "15:00 - 17:00",
                            teacher: "Nieto Hipólito Juan Iván",
                            classroom: "E34 - LCO - ARQUITECTURA",
                            subgroup: "2",
                            type: "Laboratorio"
                        };
                    }
                case 17: case 18: // 17:00 or 5:00PM
                    return {
                        tag: "odlc",
                        name: "Organización de las Computadoras",
                        hour: "17:00 - 19:00",
                        teacher: "Crespo Ragland Jonatan",
                        classroom: "E1 - 207",
                        subgroup: "Ambos",
                        type: "Clase"
                    };
                default:
                    return DEFAULT_SUBJECT_DATA;
            }
        case 3: // Thursday
            switch (hour) {
                case 13: case 14: // 13:00 or 1:00PM
                    if (localStorage.getItem("subgroup") == '1') {
                        return {
                            tag: "odlc",
                            name: "Organización de las Computadoras",
                            hour: "13:00 - 15:00",
                            teacher: "Crespo Ragland Jonatan",
                            classroom: "E40 - B",
                            subgroup: "1",
                            type: "Laboratorio"
                        };
                    } else {
                        return {
                            tag: "pe",
                            name: "Programación Estructurada",
                            hour: "13:00 - 15:00",
                            teacher: "Nuñez Yepiz Pedro",
                            classroom: "E40 - A",
                            subgroup: "2",
                            type: "Laboratorio"
                        };
                    }
                case 15: // 15:00 or 3:00PM
                    return {
                        tag: "tys",
                        name: "Tecnología y Sociedad",
                        hour: "15:00 - 16:00",
                        teacher: "Rangel Lopez Claudia Margarita",
                        classroom: "E1 - 305",
                        subgroup: "Ambos",
                        type: "Clase"
                    };
                case 16: // 16:00 or 4:00PM
                    return {
                        tag: "hu",
                        name: "Hora Universitaria",
                        hour: "16:00 - 17:00",
                        teacher: "",
                        classroom: "",
                        subgroup: "",
                        type: ""
                    };
                case 17: case 18: // 17:00 or 5:00PM
                    return {
                        tag: "md",
                        name: "Matemáticas Discretas",
                        hour: "17:00 - 19:00",
                        teacher: "Crespo Ragland Jonatan",
                        classroom: "E1 - 301",
                        subgroup: "Ambos",
                        type: "Clase"
                    };
                default:
                    return DEFAULT_SUBJECT_DATA;
            }
        case 4: // Friday
            switch (hour) {
                case 13: case 14: // 13:00 or 1:00PM
                    return {
                        tag: "lc",
                        name: "Lenguaje C",
                        hour: "13:00 - 15:00",
                        teacher: "Antillón Macías César",
                        classroom: "E1 - 209",
                        subgroup: "Ambos",
                        type: "Taller"
                    };
                case 15: case 16: // 15:00 or 3:00PM
                    return {
                        tag: "mdli",
                        name: "Metodología de la Investigación",
                        hour: "15:00 - 17:00",
                        teacher: "López Sánchez Carlos Saul",
                        classroom: "E1 - 209",
                        subgroup: "Ambos",
                        type: "Taller"
                    };
                case 17: case 18: // 17:00 or 5:00PM
                    return {
                        tag: "md",
                        name: "Matemáticas Discretas",
                        hour: "17:00 - 19:00",
                        teacher: "Crespo Ragland Jonatan",
                        classroom: "E1 - 209",
                        subgroup: "Ambos",
                        type: "Taller"
                    };
                default:
                    return DEFAULT_SUBJECT_DATA;
            }
        default:
            return DEFAULT_SUBJECT_DATA;
    }
}

function updateSubjectDataPanel(subject_data, day) {
    let subjectDataName = document.getElementById("subject-data-name");
    let subjectDataDay = document.getElementById("subject-data-day");
    let subjectDataHour = document.getElementById("subject-data-hour");
    let subjectDataTeacher = document.getElementById("subject-data-teacher");
    let subjectDataClassroom = document.getElementById("subject-data-classroom");
    let subjectDataSubgroup = document.getElementById("subject-data-subgroup");
    let subjectDataType = document.getElementById("subject-data-type");
    if (subject_data) {
        subjectDataName.textContent = subject_data.name;
        subjectDataDay.textContent = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"][day];
        subjectDataHour.textContent = subject_data.hour;
        if (subject_data.teacher == "") {
            document.getElementById("subject-data-teacher-div").style.display = "none";
        } else {
            subjectDataTeacher.textContent = subject_data.teacher;
            document.getElementById("subject-data-teacher-div").style.display = "flex";
        }
        if (subject_data.classroom == "") {
            document.getElementById("subject-data-classroom-div").style.display = "none";
        } else {
            subjectDataClassroom.textContent = subject_data.classroom;
            document.getElementById("subject-data-classroom-div").style.display = "flex";
        }
        if (subject_data.subgroup == "") {
            document.getElementById("subject-data-subgroup-div").style.display = "none";
        } else {
            subjectDataSubgroup.textContent = subject_data.subgroup;
            document.getElementById("subject-data-subgroup-div").style.display = "flex";
        }
        if (subject_data.type == "") {
            document.getElementById("subject-data-type-div").style.display = "none";
        } else {
            subjectDataType.textContent = subject_data.type;
            document.getElementById("subject-data-type-div").style.display = "flex";
        }
    }
}

function showSubjectData(day = 0, hour = 13, display = true) {
    const SUBJECT_DATA = getSubjectData(day, hour);
    updateSubjectDataPanel(SUBJECT_DATA, day);
    let subjectDataPanel = document.getElementById("subject-data-panel");
    let currentDaySelectedVar = document.getElementById("current-day-selected-var");
    let currentHourSelectedVar = document.getElementById("current-hour-selected-var");
    let subjectDataPreLineBreak = document.getElementById("subject-data-pre-line-break");
    if (subjectDataPreLineBreak) {
        if (display) {
            console.log("Debug: Showing pre-line break!");
            subjectDataPreLineBreak.style.display = "inline";
        }
    }
    if (subjectDataPanel) {
        if (display) {
            subjectDataPanel.style.display = "block";
        }
        removeSubjectDataClasses(subjectDataPanel);
        if (SUBJECT_DATA.tag) {
            subjectDataPanel.classList.add(SUBJECT_DATA.tag);
        }
        if (subjectDataPanel.getBoundingClientRect().bottom > window.innerHeight) {
            subjectDataPanel.scrollIntoView({ behavior: "smooth", block: "end" });
        }
    }
    if (currentDaySelectedVar) {
        currentDaySelectedVar.textContent = day;
    }
    if (currentHourSelectedVar) {
        currentHourSelectedVar.textContent = hour;
    }
}

function hideSubjectData() {
    let subjectDataPanel = document.getElementById("subject-data-panel");
    let subjectDataPreLineBreak = document.getElementById("subject-data-pre-line-break");
    if (subjectDataPanel) {
        subjectDataPanel.style.display = "none";
        removeSubjectDataClasses(subjectDataPanel);
    }
    if (subjectDataPreLineBreak) {
        console.log("Debug: Hiding pre-line break!");
        subjectDataPreLineBreak.style.display = "none";
    }
}

function removeSubjectDataClasses(subjectDataPanel) {
    if (subjectDataPanel) {
        subjectDataPanel.classList.remove("lc", "tys", "pe", "ea", "mdli", "odlc", "hu", "md");
    }
}
</script>
